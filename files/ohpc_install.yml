 - job:
         name: ohpc_install
         description: "This is the job to install OpenHPC on a cluster"
         project-type: freestyle
         block-downstream: false
         concurrent: true
         properties:
                 - authorization:
                         hpc-sig-admin:
                                 - credentials-create
                                 - credentials-delete
                                 - credentials-manage-domains
                                 - credentials-update
                                 - credentials-view
                                 - job-build
                                 - job-cancel
                                 - job-configure
                                 - job-delete
                                 - job-discover
                                 - job-move
                                 - job-read
                                 - job-status
                                 - job-workspace
                                 - ownership-jobs
                                 - run-delete
                                 - run-update
                                 - scm-tag
                         hpc-sig-devel:
                                 - job-build
                                 - job-read
         parameters:
                 - node:
                         name: node
                         allowed-slaves:
                                 - d05ohpc
                                 - qdfohpc
                         allowed-multiselect: true
                         ignore-offline-nodes: true
                         description: 'Node on which to execute this job'
                 - choice:
                         name: method
                         choices:
                                 - stateful
                         default: 'stateful'
                         description: 'The type of OHPC install to do'
                 - string:
                         name: client_branch
                         default: 'master'
                         description: 'Branch name of the mr-provisioner-client to use'
                 - string:
                         name: automation_branch
                         default: 'linaro'
                         description: 'Branch name of the ohpc install recipe'
         builders:
                 - shell: |
                        #!/bin/bash
                        set -ex

                        arch='aarch64'
                        mr_provisioner_url='http://10.40.0.11:5000'
                        mr_provisioner_token=$(cat "/home/${NODE_NAME}/mrp_token")
                        force_service=True

                        if [ ${node} == 'qdfohpc' ]; then
                                master_name='qdfohpc'
                                cnode01='qdf01'
                                cnode02='qdf02'
                                cnode03='qdf03'
                                master_eth_internal='eth0'
                                eth_provision='eth0'
                                num_compute='3'
                                compute_prefix='qdf0'
                                compute_regex='qdf0[1-3]'
                                kargs=''
                                additional_modules='qcom_emac'
                        elif [ ${node} == 'd05ohpc' ]; then
                                master_name='d05ohpc'
                                cnode01='d0301'
                                cnode02='d0302'
                                cnode03='d0303'
                                master_eth_internal='enahisic2i1'
                                eth_provision='enahisic2i1'
                                num_compute='3' 
                                compute_prefix='d030'
                                compute_regex='d030[1-3]'
                                kargs=''
                        fi

                        if [ -d ${WORKSPACE}/mr-provisioner-client ]; then
                            rm -rf ${WORKSPACE}/mr-provisioner-client
                        fi
                        git clone -b ${client_branch} https://github.com/Linaro/mr-provisioner-client.git ${WORKSPACE}/mr-provisioner-client

                        master_ip=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getip --machine ${master_name} --interface eth1 )
                        cnode01ip=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getip --machine ${cnode01} --interface eth1 )
                        cnode01mac=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getmac --machine ${cnode01} --interface eth1 )
                        cnode02ip=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getip --machine ${cnode02} --interface eth1 )
                        cnode02mac=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getmac --machine ${cnode02} --interface eth1 )
                        cnode03ip=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getip --machine ${cnode03} --interface eth1 )
                        cnode03mac=$( ./mr-provisioner-client/mrp_client.py --mrp-url=${mr_provisioner_url} --mrp-token=${mr_provisioner_token} net --action getmac --machine ${cnode03} --interface eth1 )

                        if [ ${method} == 'stateful' ]; then
                                internal_network='10.40.0.0'
                                internal_netmask='255.255.0.0'
                                internal_broadcast='10.40.255.255'
                                internal_gateway='10.40.0.1'
                                internal_dns=${internal_gateway}
                                internal_domain_name=''
                                # Enable components options
                                enable_beegfs_client=False
                                enable_mpi_defaults=True
                                enable_mpi_opa=False
                                enable_clustershell=True
                                enable_ipmisol=False
                                enable_opensm=False
                                enable_ipoib=False
                                enable_ganglia=False
                                enable_genders=False
                                enable_kargs=False
                                enable_lustre_client=False
                                enable_mrsh=False
                                enable_nagios=False
                                enable_powerman=False
                                enable_intel_packages=False
                                enable_dhcpd_server=False
                                enable_ifup=False
                                enable_warewulf=False
                                enable_nfs_ohpc=True
                                enable_nfs_home=True
                                enable_helloworld=True

                        else
                                echo 'Stateless not implemented'
                                exit 1
                        fi

                        cat << EOF > ${WORKSPACE}/hosts
                        [sms]
                        ${master_ip}
                        [cnodes]
                        ${cnode01ip}
                        ${cnode02ip}
                        ${cnode03ip}
                        [ionodes]
                        ${master_ip}
                        [devnodes]
                        ${master_ip}
                        EOF

                        cat << EOF > ${WORKSPACE}/ohpc_installation.yml
                        sms_name: ${master_name}
                        sms_ip: ${master_ip}
                        sms_eth_internal: ${master_eth_internal}
                        internal_network: ${internal_network}
                        internal_netmask: ${internal_netmask}
                        internal_broadcast: ${internal_broadcast}
                        internal_gateway: ${internal_gateway}
                        internal_domain_name: ${internal_domain_name}
                        internal_domain_name_servers: ${internal_dns}
                        eth_provision: ${eth_provision}
                        cnode_eth_internal: ${eth_provision}
                        force_service: ${force_service}
                        enable_beegfs_client: ${enable_beegfs_client}
                        enable_mpi_defaults: ${enable_mpi_defaults} 
                        enable_mpi_opa: ${enable_mpi_opa}
                        enable_clustershell: ${enable_clustershell}
                        enable_ipmisol: ${enable_ipmisol}
                        enable_opensm: ${enable_opensm}
                        enable_ipoib: ${enable_ipoib}
                        enable_ganglia: ${enable_ganglia}
                        enable_genders: ${enable_genders}
                        enable_kargs: ${enable_kargs}
                        enable_lustre_client: ${enable_lustre_client}
                        enable_mrsh: ${enable_mrsh}
                        enable_nagios: ${enable_nagios}
                        enable_powerman: ${enable_powerman}
                        enable_intel_packages: ${enable_intel_packages}
                        enable_dhcpd_server: ${enable_dhcpd_server}
                        enable_ifup: ${enable_ifup}
                        enable_warewulf: ${enable_warewulf}
                        enable_nfs_ohpc: ${enable_nfs_ohpc}
                        enable_nfs_home: ${enable_nfs_home}
                        enable_helloworld: ${enable_helloworld}
                        kargs: ${kargs}
                        additional_modules: ${additional_modules}
                        num_computes: ${num_compute}
                        compute_regex: ${compute_regex}
                        compute_prefix: ${compute_prefix}
                        compute_nodes:
                        - { num: 1, c_name: "${cnode01}", c_ip: "${cnode01ip}", c_mac: "${cnode01mac}", c_bmc: "10.41.1.0"}
                        - { num: 2, c_name: "${cnode02}", c_ip: "${cnode02ip}", c_mac: "${cnode02mac}", c_bmc: "10.41.1.0"}
                        - { num: 3, c_name: "${cnode03}", c_ip: "${cnode03ip}", c_mac: "${cnode03mac}", c_bmc: "10.41.1.0"}
                        EOF

                        if [ -d ${WORKSPACE}/ansible-playbook-for-ohpc ]; then
                            rm -rf ${WORKSPACE}/ansible-playbook-for-ohpc
                        fi
                        git clone -b ${automation_branch} https://github.com/Linaro/ansible-playbook-for-ohpc.git ${WORKSPACE}/ansible-playbook-for-ohpc

                        eval `ssh-agent`
                        ssh-add
                        ANSIBLE_CONFIG=${WORKSPACE}/ansible-playbook-for-ohpc/ansible.cfg ansible-playbook ${WORKSPACE}/ansible-playbook-for-ohpc/site.yml --extra-vars="@${WORKSPACE}/ohpc_installation.yml" -i ${WORKSPACE}/hosts
                        ssh-agent -k 
