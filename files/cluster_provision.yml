 - job:
         name: cluster_provision
         description: "This is the job to provision a cluster using MrP"
         project-type: freestyle
         block-downstream: false
         concurrent: true
         node: "xecutor"
         properties:
                 - authorization:
                         hpc-sig-admin:
                                 - credentials-create
                                 - credentials-delete
                                 - credentials-manage-domains
                                 - credentials-update
                                 - credentials-view
                                 - job-build
                                 - job-cancel
                                 - job-configure
                                 - job-delete
                                 - job-discover
                                 - job-move
                                 - job-read
                                 - job-status
                                 - job-workspace
                                 - ownership-jobs
                                 - run-delete
                                 - run-update
                                 - scm-tag
                         hpc-sig-devel:
                                 - job-build
                                 - job-read
         parameters:
                 - string:
                         name: cluster_script_branch
                         default: 'master'
                         description: 'The branch of the cluster_provision job logic to use'
                 - string:
                         name: provisioning_script_branch
                         default: 'master'
                         description: 'The branch of the provisioning job logic to use'
                 - choice:
                         name: machine_type
                         choices:
                                 - d05
                                 - qdc
                         default: 'qdc'
                         description: 'The cluster of machines to be provisioned'
         builders:
                 - shell: |
                        #!/bin/bash
                        set -ex

                        # Chose known good kernel/initrd/cmdline
                        if [ ${machine_type} == "qdc" ]; then
                                machine_list="qdcohpc, qdc01, qdc02, qdc03"
                                preseed_type="kickstart"
                                kernel_desc="CentOS 7.5"
                                initrd_desc="CentOS 7.5"
                                preseed_name="CentOS Upstream"
                                kernel_opts="ip=dhcp text inst.stage2=http://mirror.centos.org/altarch/7/os/aarch64/ inst.repo=http://mirror.centos.org/altarch/7/os/aarch64/ inst.ks=file:/ks.cfg"
                        elif [ ${machine_type} == "d05" ]; then
                                machine_list="d05ohpc, d0301, d0302, d0303"
                                preseed_type="kickstart"
                                kernel_desc="CentOS ERP 18.06"
                                initrd_desc="CentOS ERP 18.06"
                                preseed_name="CentOS"
                                kernel_opts="ip=dhcp text inst.stage2=http://releases.linaro.org/reference-platform/enterprise/18.06/centos-installer/ inst.repo=http://mirror.centos.org/altarch/7/os/aarch64/ inst.ks=file:/ks.cfg"
                        fi

                        if [ -d "${WORKSPACE}/hpc_lab_setup" ]; then
                                rm -rf "${WORKSPACE}/hpc_lab_setup"
                        fi
                        git clone -b ${cluster_script_branch} https://github.com/Linaro/hpc_lab_setup.git "${WORKSPACE}/hpc_lab_setup"

                        bash "${WORKSPACE}/hpc_lab_setup/files/scripts/cluster_provision.sh" --workspace "${WORKSPACE}" --machine_type "${machine_type}" --machine_list "${machine_list}" --preseed_type "${preseed_type}" --kernel_desc "${kernel_desc}" --initrd_desc "${initrd_desc}" --preseed_name "${preseed_name}" --kernel_opts "${kernel_opts}" --scripts_branch "${provisioning_script_branch}"

                        if [ ! -f "${WORKSPACE}/machine_provision" ]; then
                                exit 1
                        fi

                 - conditional-step:
                         condition-kind: file-exists
                         condition-filename: machine_provision
                         steps:
                                 - trigger-builds:
                                         - project: 'machine_provision'
                                           property-file: machine_provision
                                           current-parameters: true
                                           node-label-name: "xecutor"
                                           node-label: "xecutor"
                                           block: true
