 - job:
         name: provisioning_job
         description: "This is a job for Provisioning a Machine using MrP"
         project-type: freestyle
         concurrent: true
         block-downstream: false
         properties:
                 - authorization:
                         hpc-sig-admin:
                                 - credentials-create
                                 - credentials-delete
                                 - credentials-manage-domains
                                 - credentials-update
                                 - credentials-view
                                 - job-build
                                 - job-cancel
                                 - job-configure
                                 - job-delete
                                 - job-discover
                                 - job-move
                                 - job-read
                                 - job-status
                                 - job-workspace
                                 - ownership-jobs
                                 - run-delete
                                 - run-update
                                 - scm-tag
                         hpc-sig-devel:
                                 - job-build
                                 - job-read
         parameters:
                 - node:
                         name: node
                         default: ''
                         description: 'Node with which to provision the machine'
                 - string:
                         name: scripts_branch
                         default: 'master'
                         description: 'The branch of the job logic to use'
                 - string:
                         name: machine_name
                         default: ''
                         description: 'The MrP name of the machine to provision'
                 - string:
                         name: kernel_desc
                         default: ''
                         description: 'The exact description in MrP of the kernel to be used'
                 - string:
                         name: initrd_desc
                         default: ''
                         description: 'The exact description in MrP of the initrd to be used'
                 - string:
                         name: preseed_name
                         default: ''
                         description: 'The exact name in MrP of the preseed to be used'
                 - string:
                         name: preseed_type
                         default: 'preseed'
                         description: 'The type of the preseed to be used (preseed or kickstart)'
                 - string:
                         name: machine_arch
                         default: ''
                         description: 'The name of the architecture in MrP of the machine to be provisioned'
                 - string:
                         name: machine_subarch
                         default: ''
                         description: 'The name of the subarchitecture in MrP (bootloader)'
                 - string:
                         name: kernel_opts
                         default: ''
                         description: 'The arguments to be passed to the kernel'
                 - string:
                         name: kernel_path
                         default: ''
                         description: 'The path to the kernel file to be (non compulsory) uploaded'
                 - string:
                         name: initrd_path
                         default: ''
                         description: 'The path to the initrd file to be (non compulsory) uploaded'
                 - string:
                         name: preseed_path
                         default: ''
                         description: 'The path to the preseed file to be (non compulsory) uploaded'
                 - choice:
                         name: branch
                         choices:
                            - master
                            - bger
                            - rengolin
                         default: 'master'
                         description: 'The branch of the provisioning job to use'
         builders:
                 - shell: |
                        #!/bin/bash
                        set -ex

                        if [ -d "hpc_lab_setup" ]; then
                                rm -rf hpc_lab_setup
                        fi 
                        git clone -b ${scripts_branch} https://github.com/Linaro/hpc_lab_setup.git
                        
                        bash hpc_lab_setup/files/scripts/provisioning_job.sh -w "${WORKSPACE}" -m "${machine_name}" -k "${kernel_desc}" -i "${initrd_desc}" -b "${branch}" -n "${preseed_name}" -t "${preseed_type}" -a "${machine_arch}" -s "${machine_subarch}" -o "${kernel_opts}" -p "${kernel_path}" -y "${initrd_path}" -u "${preseed_path}" -v
